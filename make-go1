#!/bin/sh -e

# This script creates a branch called go1 that has one commit beyond
# HEAD that includes the working tree and all autogenerated files.
# This makes the project work for go get, which doesn't run go
# generate.

make
make stc.1
(cd goxdr && make goxdr.1)

GIT_DIR=$(git rev-parse --git-dir)
export GIT_INDEX_FILE="$GIT_DIR/index.gh-pages"
rm -f "$GIT_INDEX_FILE"

git read-tree HEAD
git add -u
git add -f xdr_generated.go stc.1 xdr/*.x \
    goxdr/header.go goxdr/parse.go goxdr/goxdr.1

tree=$(git write-tree)
rm -f "$GIT_INDEX_FILE"
commit=$(echo 'include generated files for go1 branch' | \
	     git commit-tree -p HEAD $tree)

git branch -f go1 $commit

if github=$(git remote -v | sed -ne '/git@github.com/{s/[ 	].*//p;q;}')
then
    cat <<EOF
Now you may want to run:

    git push -f $github go1

EOF
fi

